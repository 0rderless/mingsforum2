<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MingForum - Secured & Fixed</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    :root {
      --brand: #ff4500;
      --brand-glow: rgba(255, 69, 0, 0.4);
      --bg: radial-gradient(circle at top left, #121212, #050505);
      --card: rgba(30, 30, 32, 0.7);
      --border: rgba(255, 255, 255, 0.1);
      --text: #e1e3e6;
      --subtext: #818384;
      --staff: #ffd700;
      --staff-glow: rgba(255, 215, 0, 0.3);
      --glass: blur(12px);
    }
    [data-theme="light"] {
      --bg: #f0f2f5; --card: rgba(255, 255, 255, 0.8);
      --border: rgba(0, 0, 0, 0.1); --text: #1c1e21; --subtext: #65676b;
    }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; transition: 0.4s; }
    #app-screen { display: none; height: 100vh; display: flex; }
    nav { width: 250px; background: var(--card); backdrop-filter: var(--glass); border-right: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
    #forum-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    header { background: var(--card); backdrop-filter: var(--glass); padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    #main-feed { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .post-card { width: 100%; max-width: 700px; background: var(--card); backdrop-filter: var(--glass); border: 1px solid var(--border); border-radius: 16px; padding: 20px; transition: 0.2s; position: relative; }
    .staff-post { border: 1.5px solid var(--staff) !important; box-shadow: 0 0 15px var(--staff-glow); }
    .staff-badge { background: var(--staff); color: black; padding: 2px 6px; border-radius: 4px; font-weight: 900; font-size: 10px; margin-left: 5px; vertical-align: middle; }
    .btn { background: var(--brand); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
    .auth-input, textarea { width: 100%; padding: 12px; margin-bottom: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); border-radius: 8px; box-sizing: border-box; outline: none; }
    .nav-item { padding: 12px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .nav-item.active { background: var(--brand); color: white; }
    .xp-bar-bg { background: rgba(255,255,255,0.1); height: 6px; border-radius: 10px; margin-top: 8px; overflow: hidden; }
    .xp-bar-fill { background: var(--brand); height: 100%; transition: width 0.5s; }
    .active-box { margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px; }
    .active-user { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 5px; }
    .dot { width: 7px; height: 7px; background: #4ade80; border-radius: 50%; box-shadow: 0 0 5px #4ade80; }
    #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; align-items: center; justify-content: center; }
    .comment-node { margin-top: 10px; padding-left: 10px; border-left: 2px solid var(--border); font-size: 14px; }
    .delete-btn { float: right; color: #ff4444; cursor: pointer; font-size: 10px; font-weight: bold; background: rgba(255,0,0,0.1); padding: 4px 8px; border-radius: 4px; }
    .delete-btn:hover { background: #ff4444; color: white; }
  </style>
</head>
<body data-theme="dark">

  <div id="auth-screen">
    <div class="post-card" style="width: 350px; text-align: center;">
      <h2 style="color:var(--brand)">MingForum</h2>
      <div id="auth-main">
        <input type="text" id="auth-user" class="auth-input" placeholder="Username">
        <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
        <button class="btn" onclick="handleAuth('login')">Sign In</button>
        <button class="btn" onclick="handleAuth('signup')" style="background:transparent; border:1px solid var(--border); margin-top:10px;">Sign Up</button>
        <p onclick="showGuest()" style="cursor:pointer; color:var(--subtext); font-size:12px; margin-top:15px;">Enter as Guest</p>
      </div>
      <div id="auth-guest" style="display:none;">
        <input type="text" id="guest-name" class="auth-input" placeholder="Guest Nickname">
        <button class="btn" onclick="handleAuth('guest')">Enter</button>
      </div>
    </div>
  </div>

  <div id="app-screen">
    <nav>
      <h2 style="color:var(--brand)">MingForum</h2>
      <div id="nav-general" class="nav-item active" onclick="switchForum('general')">üè† General</div>
      <div id="nav-anime" class="nav-item" onclick="switchForum('anime')">üì∫ Anime</div>
      <div id="nav-gaming" class="nav-item" onclick="switchForum('gaming')">üéÆ Gaming</div>
      
      <div class="active-box">
        <div style="font-size:10px; color:var(--brand); font-weight:bold; margin-bottom:8px;">ACTIVE NOW</div>
        <div id="active-list"></div>
      </div>

      <div style="flex:1"></div>
      <div class="nav-item" onclick="toggleTheme()" style="background:rgba(255,255,255,0.05)">üåì Toggle Theme</div>
      <div style="padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; margin-bottom:10px;">
        <div id="my-name-side" style="font-weight:bold; font-size:14px;"></div>
        <div id="my-lvl-side" style="font-size:11px; color:var(--subtext);">Level 1</div>
        <div class="xp-bar-bg"><div id="xp-fill" class="xp-bar-fill" style="width: 0%"></div></div>
      </div>
      <button class="btn" onclick="location.reload()" style="background:none; border:1px solid var(--border)">Logout</button>
    </nav>

    <div id="forum-container">
      <header>
        <span id="header-title" style="font-weight:bold;">GENERAL</span>
        <span id="my-name-display" style="cursor:pointer; font-weight:bold;" onclick="openProfile(userObj.key)"></span>
      </header>
      <div id="main-feed">
        <div class="post-card">
          <input type="text" id="post-t" class="auth-input" placeholder="Title">
          <textarea id="post-c" rows="2" placeholder="Start Minging..."></textarea>
          <button class="btn" onclick="createPost()">Post</button>
        </div>
        <div id="posts-list" style="width:100%; display:flex; flex-direction:column; gap:20px; align-items:center;"></div>
      </div>
    </div>
  </div>

  <div id="profile-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:6000; align-items:center; justify-content:center;" onclick="this.style.display='none'">
    <div class="post-card" style="width:340px; text-align:center;" onclick="event.stopPropagation()">
      <div style="font-size: 50px;">üë§</div>
      <h2 id="view-name"></h2>
      <p id="view-level" style="color:var(--brand); font-weight:bold;"></p>
      <div style="margin:20px 0;">Followers: <b id="view-followers" style="font-size:20px;">0</b></div>
      <button class="btn" onclick="toggleFollow()">Follow</button>
      <button id="staff-boost-btn" class="btn" style="display:none; background:var(--staff); color:black; margin-top:10px;" onclick="staffBoost()">+10 Followers (Staff)</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCf1_uelYRFLSW8e652hHBppFUwmegkJE0",
      authDomain: "mingchat-e8a29.firebaseapp.com",
      databaseURL: "https://mingchat-e8a29-default-rtdb.firebaseio.com",
      projectId: "mingchat-e8a29",
      storageBucket: "mingchat-e8a29.appspot.com",
      messagingSenderId: "570070920841",
      appId: "1:570070920841:web:fa45f0f67b6fb33598e058"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userObj = null, currentForum = 'general', viewingKey = null;

    function toggleTheme() {
      const b = document.body;
      b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    function getLvlInfo(xp) {
      let lvl = Math.floor((xp || 0) / 100) + 1;
      return { lvl: "Level " + lvl, progress: (xp % 100) };
    }

    function showGuest() {
      document.getElementById('auth-main').style.display = 'none';
      document.getElementById('auth-guest').style.display = 'block';
    }

    function handleAuth(type) {
      let name = (type === 'guest') ? document.getElementById('guest-name').value.trim() : document.getElementById('auth-user').value.trim();
      let pass = document.getElementById('auth-pass').value;
      if(!name) return;
      if (type === 'guest' && name.toLowerCase() === 'mings') { alert("Reserved Staff name."); return; }
      const key = name.toLowerCase().replace(/[^a-z0-9]/g, '');

      if(type === 'guest') {
        userObj = { name: name, key: 'guest_'+Date.now(), isGuest: true, xp: 0 };
        enterApp();
        return;
      }
      db.ref('users/'+key).once('value').then(snap => {
        if(type === 'signup') {
          if(snap.exists()) return alert("Taken");
          const d = { name, password: pass, xp: 0, followers: 0 };
          db.ref('users/'+key).set(d).then(() => { userObj = d; userObj.key = key; enterApp(); });
        } else {
          if(snap.exists() && snap.val().password === pass) { 
            userObj = snap.val(); userObj.key = key; enterApp(); 
          } else alert("Invalid Login");
        }
      });
    }

    function enterApp() {
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app-screen').style.display = 'flex';
      updateSidebar();
      switchForum('general');
      startPresence();
    }

    function startPresence() {
      const pRef = db.ref('presence/' + userObj.key);
      pRef.set({ name: userObj.name, lastSeen: Date.now() });
      pRef.onDisconnect().remove();
      setInterval(() => pRef.update({ lastSeen: Date.now() }), 10000);
      db.ref('presence').on('value', snap => {
        const list = document.getElementById('active-list');
        list.innerHTML = "";
        snap.forEach(u => { if (Date.now() - u.val().lastSeen < 60000) list.innerHTML += `<div class="active-user"><div class="dot"></div>${u.val().name}</div>`; });
      });
    }

    function updateSidebar() {
      const info = getLvlInfo(userObj.xp);
      document.getElementById('my-name-display').innerText = userObj.name;
      document.getElementById('my-name-side').innerText = userObj.name;
      document.getElementById('my-lvl-side').innerText = info.lvl;
      document.getElementById('xp-fill').style.width = info.progress + "%";
    }

    function switchForum(n) {
      currentForum = n;
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
      document.getElementById('nav-'+n).classList.add('active');
      document.getElementById('header-title').innerText = n.toUpperCase();
      loadForum(n);
    }

    function loadForum(n) {
      const list = document.getElementById('posts-list');
      list.innerHTML = "";
      db.ref('forums/'+n).off();
      
      // Listener for adding posts
      db.ref('forums/'+n).on('child_added', snap => {
        const p = snap.val();
        db.ref('users/'+p.userKey).once('value').then(uSnap => {
          const ud = uSnap.val() || {xp:0};
          const isStaff = p.user.toLowerCase() === 'mings' && !p.isGuest;
          const iAmStaff = userObj.name.toLowerCase() === 'mings' && !userObj.isGuest;
          
          const card = document.createElement('div');
          card.className = `post-card ${isStaff ? 'staff-post' : ''}`;
          card.id = `post-${snap.key}`;
          card.innerHTML = `
            ${iAmStaff ? `<span class="delete-btn" onclick="deletePost('${snap.key}')">DELETE</span>` : ''}
            <div style="font-size:12px; margin-bottom:10px; color:var(--subtext)">
              <span class="name-wrapper" onclick="openProfile('${p.userKey}')">${p.user}</span>
              ${isStaff ? '<span class="staff-badge">STAFF</span>' : ''}
              <span style="margin-left:8px; background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">${getLvlInfo(ud.xp).lvl}</span>
            </div>
            <div style="font-weight:bold; font-size:18px;">${p.title}</div>
            <div style="margin:10px 0;">${p.content}</div>
            <div id="coms-sec-${snap.key}">
              <div style="display:flex; gap:5px;">
                <input type="text" id="in-${snap.key}" class="auth-input" style="margin:0; flex:1; height:35px;" placeholder="Reply...">
                <button class="btn" onclick="addComment('${snap.key}')" style="width:60px; height:35px; padding:0;">Send</button>
              </div>
              <div id="coms-${snap.key}"></div>
            </div>`;
          list.prepend(card);
          loadComments(snap.key);
        });
      });

      // Listener for deleting posts instantly from UI
      db.ref('forums/'+n).on('child_removed', snap => {
        const el = document.getElementById(`post-${snap.key}`);
        if(el) el.remove();
      });
    }

    function deletePost(key) {
      if(confirm("Are you sure you want to delete this post?")) {
        db.ref('forums/'+currentForum+'/'+key).remove();
      }
    }

    function createPost() {
      const t = document.getElementById('post-t').value, c = document.getElementById('post-c').value;
      if(!t || !c) return;
      db.ref('forums/'+currentForum).push({ user: userObj.name, userKey: userObj.key, isGuest: !!userObj.isGuest, title: t, content: c });
      if(!userObj.isGuest) { userObj.xp += 10; db.ref('users/'+userObj.key+'/xp').set(userObj.xp); updateSidebar(); }
      document.getElementById('post-t').value = ""; document.getElementById('post-c').value = "";
    }

    function addComment(pk) {
      const inp = document.getElementById('in-'+pk);
      if(!inp.value.trim()) return;
      db.ref('comments/'+pk).push({ user: userObj.name, text: inp.value });
      if(!userObj.isGuest) { userObj.xp += 5; db.ref('users/'+userObj.key+'/xp').set(userObj.xp); updateSidebar(); }
      inp.value = "";
    }

    function loadComments(pk) {
      db.ref('comments/'+pk).on('child_added', snap => {
        const d = snap.val();
        const div = document.createElement('div');
        div.className = 'comment-node';
        div.innerHTML = `<b>${d.user}:</b> ${d.text}`;
        document.getElementById('coms-'+pk).appendChild(div);
      });
    }

    function openProfile(k) {
      if (!k || k.startsWith('guest')) return;
      viewingKey = k;
      db.ref('users/'+k).on('value', snap => {
        const d = snap.val(); if(!d) return;
        document.getElementById('view-name').innerText = d.name;
        document.getElementById('view-level').innerText = getLvlInfo(d.xp).lvl;
        document.getElementById('view-followers').innerText = d.followers || 0;
        document.getElementById('profile-overlay').style.display = 'flex';
        document.getElementById('staff-boost-btn').style.display = (userObj.name.toLowerCase() === 'mings' && !userObj.isGuest) ? 'block' : 'none';
      });
    }

    function toggleFollow() {
      if(viewingKey === userObj.key) return alert("Self-following is disabled.");
      db.ref('users/'+viewingKey+'/followers').transaction(c => (c || 0) + 1);
    }

    function staffBoost() { db.ref('users/'+viewingKey+'/followers').transaction(c => (c || 0) + 10); }
  </script>
</body>
</html>