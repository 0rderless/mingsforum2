<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MingCord Pro - Absolute Build</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    :root {
      --bg-1: #1e1f22; --bg-2: #2b2d31; --bg-3: #313338; --bg-4: #232428;
      --text-1: #f2f3f5; --text-muted: #949ba4; --brand: #5865f2;
      --online: #23a559; --offline: #80848e; --owner: #f1c40f;
    }
    body { margin: 0; font-family: sans-serif; background: var(--bg-1); color: var(--text-1); height: 100vh; display: flex; overflow: hidden; }
    
    /* RAIL */
    .server-rail { width: 72px; background: var(--bg-1); display: flex; flex-direction: column; align-items: center; padding-top: 12px; gap: 8px; flex-shrink: 0; }
    .s-btn { width: 48px; height: 48px; background: var(--bg-3); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-weight: bold; font-size: 18px; }
    .s-btn:hover, .s-btn.active { border-radius: 16px; background: var(--brand); }

    /* SIDEBAR */
    .sidebar { width: 240px; background: var(--bg-2); display: flex; flex-direction: column; flex-shrink: 0; }
    .sb-header { height: 48px; padding: 0 16px; display: flex; align-items: center; font-weight: bold; border-bottom: 1px solid rgba(0,0,0,0.2); justify-content: space-between; }
    .sb-content { flex: 1; padding: 10px 8px; overflow-y: auto; }
    .item { padding: 8px; border-radius: 4px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; margin-bottom: 2px; transition: 0.1s; }
    .item:hover, .item.active { background: #3f4147; color: white; }

    /* CHAT */
    .chat { flex: 1; background: var(--bg-3); display: flex; flex-direction: column; min-width: 0; }
    .chat-scroller { flex: 1; overflow-y: auto; padding: 16px; }
    .msg { display: flex; gap: 14px; margin-bottom: 16px; }
    .pfp-box { width: 40px; height: 40px; border-radius: 50%; background: #4e5058; flex-shrink: 0; overflow: hidden; }
    .pfp-box img { width: 100%; height: 100%; object-fit: cover; }

    /* MEMBERS */
    .members { width: 240px; background: var(--bg-2); padding: 10px 16px; overflow-y: auto; flex-shrink: 0; border-left: 1px solid rgba(0,0,0,0.1); }
    .m-title { font-size: 12px; font-weight: bold; color: var(--text-muted); margin: 15px 0 5px; text-transform: uppercase; }
    .m-user { display: flex; align-items: center; gap: 8px; padding: 5px 0; font-size: 14px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--bg-2); }
    .on { background: var(--online); } .off { background: var(--offline); }

    /* MODALS */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: var(--bg-2); padding: 24px; border-radius: 8px; width: 320px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
    input { width: 100%; padding: 10px; margin: 10px 0; background: var(--bg-1); border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; outline: none; }
    .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
    .btn-brand { background: var(--brand); color: white; }
  </style>
</head>
<body>

  <div id="auth" class="modal" style="display:flex">
    <div class="modal-box">
      <h2 style="text-align:center; color:var(--brand)">MingCord</h2>
      <input id="u" placeholder="Username">
      <input id="p" type="password" placeholder="Password (Optional)">
      <button class="btn btn-brand" onclick="login()">Connect</button>
    </div>
  </div>

  <div id="p-modal" class="modal" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()">
      <h3>Profile Settings</h3>
      <div style="text-align:center; margin-bottom:15px;">
        <img id="p-preview" style="width:80px; height:80px; border-radius:50%; object-fit:cover; background:#444;">
        <input type="file" id="p-file" style="display:none" onchange="uploadPFP(this)">
        <button class="btn" style="background:#444; color:white; font-size:12px; margin-top:10px;" onclick="document.getElementById('p-file').click()">Pick Image from PC</button>
      </div>
      <button class="btn btn-brand" onclick="document.getElementById('p-modal').style.display='none'">Close</button>
    </div>
  </div>

  <nav class="server-rail">
    <div class="s-btn" onclick="showHome()">H</div>
    <div style="width:32px; height:2px; background:#35363c; margin: 4px 0;"></div>
    <div id="serv-list"></div>
    <div class="s-btn" style="color:var(--online)" onclick="actionServer()">+</div>
  </nav>

  <aside class="sidebar">
    <div class="sb-header" id="side-title">Direct Messages</div>
    <div class="sb-content" id="side-list"></div>
    <div style="background:var(--bg-4); padding:10px; display:flex; align-items:center; gap:8px; cursor:pointer;" onclick="openProfile()">
      <div class="pfp-box" style="width:32px; height:32px;" id="my-pfp-box">
        <img id="my-pfp-img" src="">
      </div>
      <div id="my-name" style="font-size:13px; font-weight:bold;">User</div>
    </div>
  </aside>

  <main class="chat">
    <div class="sb-header">
        <span id="chat-title">Welcome</span>
        <button id="inv-btn" style="display:none; background:#444; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;" onclick="showInv()">Invite Code</button>
    </div>
    <div class="chat-scroller" id="msg-mount"></div>
    <div style="padding: 16px;">
      <input id="msg-in" placeholder="Message..." onkeypress="if(event.key==='Enter') send()">
    </div>
  </main>

  <aside class="members">
    <div id="member-list"></div>
  </aside>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCf1_uelYRFLSW8e652hHBppFUwmegkJE0",
      authDomain: "mingchat-e8a29.firebaseapp.com",
      databaseURL: "https://mingchat-e8a29-default-rtdb.firebaseio.com",
      projectId: "mingchat-e8a29",
      storageBucket: "mingchat-e8a29.appspot.com",
      messagingSenderId: "570070920841",
      appId: "1:570070920841:web:fa45f0f67b6fb33598e058"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = null, curView = 'home', curId = null;

    function login() {
      const u = document.getElementById('u').value.toLowerCase().trim();
      if(!u) return;
      db.ref('users/'+u).once('value', s => {
        if(s.exists()){
            user = s.val();
        } else {
            user = { name: u, role: u === 'mings' ? 'Owner' : 'Member', pfp: "", servers: [] };
            db.ref('users/'+u).set(user);
        }
        startApp();
      });
    }

    function startApp() {
      document.getElementById('auth').style.display = 'none';
      // Real-time listener for user data (PFP and Server list)
      db.ref('users/'+user.name).on('value', snap => {
        user = snap.val();
        document.getElementById('my-name').innerText = user.name;
        document.getElementById('my-pfp-img').src = user.pfp || "https://www.gravatar.com/avatar/?d=mp";
        loadServers();
      });

      const pRef = db.ref('presence/'+user.name);
      pRef.set({ status: 'on', pfp: user.pfp || '' });
      pRef.onDisconnect().remove();
      
      showHome();
    }

    function showHome() {
      curView = 'home'; curId = null;
      document.getElementById('side-title').innerText = 'Home';
      document.getElementById('chat-title').innerText = 'Global Lounge';
      document.getElementById('inv-btn').style.display = 'none';
      document.getElementById('side-list').innerHTML = `<div class="item active"># global-chat</div>`;
      loadMessages('global_chat');
      syncGlobalMembers();
    }

    function actionServer() {
      const act = prompt("Type 'CREATE' to start a server or 'JOIN' to enter a code:");
      if(!act) return;
      if(act.toUpperCase() === 'CREATE') {
        const n = prompt("Server Name:");
        if(n) {
          const ref = db.ref('servers').push();
          ref.set({ name: n, owner: user.name }).then(() => {
            const list = user.servers || [];
            db.ref('users/'+user.name+'/servers').set([...list, ref.key]);
            alert("Server Created! Invite Code: " + ref.key);
          });
        }
      } else if(act.toUpperCase() === 'JOIN') {
        const code = prompt("Paste Invite Code:");
        if(code) {
          db.ref('servers/'+code).once('value', s => {
            if(!s.exists()) return alert("Invalid Code");
            const list = user.servers || [];
            if(!list.includes(code)) {
              db.ref('users/'+user.name+'/servers').set([...list, code]);
            }
          });
        }
      }
    }

    function loadServers() {
      const mount = document.getElementById('serv-list'); mount.innerHTML = "";
      if(!user.servers) return;
      user.servers.forEach(sid => {
        db.ref('servers/'+sid).once('value', snap => {
          const d = snap.val(); if(!d) return;
          const div = document.createElement('div');
          div.className = 's-btn'; div.innerText = d.name[0].toUpperCase();
          div.onclick = () => selectServer(sid, d);
          mount.appendChild(div);
        });
      });
    }

    function selectServer(id, data) {
      curId = id; curView = 'server';
      document.getElementById('side-title').innerText = data.name;
      document.getElementById('chat-title').innerText = "# general";
      document.getElementById('inv-btn').style.display = 'block';
      document.getElementById('side-list').innerHTML = `<div class="item active"># general</div>`;
      loadMessages('srv_msgs/' + id);
      syncServerMembers();
    }

    function loadMessages(path) {
      const mount = document.getElementById('msg-mount'); mount.innerHTML = "";
      db.ref(path).off();
      db.ref(path).on('child_added', snap => {
        const m = snap.val();
        const color = m.user === 'mings' ? 'var(--owner)' : 'inherit';
        mount.innerHTML += `
          <div class="msg">
            <div class="pfp-box"><img src="${m.pfp || 'https://www.gravatar.com/avatar/?d=mp'}"></div>
            <div>
              <b style="color:${color}">${m.user}</b>
              <div style="font-size:15px; margin-top:2px;">${m.text}</div>
            </div>
          </div>`;
        mount.scrollTop = mount.scrollHeight;
      });
    }

    function send() {
      const inp = document.getElementById('msg-in'); if(!inp.value.trim()) return;
      const path = curView === 'server' ? 'srv_msgs/'+curId : 'global_chat';
      db.ref(path).push({ user: user.name, text: inp.value, pfp: user.pfp || '' });
      inp.value = "";
    }

    function uploadPFP(input) {
      const file = input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64 = e.target.result;
        db.ref('users/'+user.name).update({ pfp: base64 });
        db.ref('presence/'+user.name).update({ pfp: base64 });
        document.getElementById('p-preview').src = base64;
      };
      reader.readAsDataURL(file);
    }

    function openProfile() {
      document.getElementById('p-modal').style.display = 'flex';
      document.getElementById('p-preview').src = user.pfp || "https://www.gravatar.com/avatar/?d=mp";
    }

    function syncGlobalMembers() {
      db.ref('presence').on('value', snap => {
        const mount = document.getElementById('member-list');
        mount.innerHTML = `<div class="m-title">Online â€” ${snap.numChildren()}</div>`;
        snap.forEach(p => {
            mount.innerHTML += `<div class="m-user"><div class="status-dot on"></div> ${p.key}</div>`;
        });
      });
    }

    function syncServerMembers() {
        // Simple logic for Pro version: Show everyone online in the sidebar when in a server
        syncGlobalMembers(); 
    }

    function showInv() { prompt("Share this code to invite friends:", curId); }
  </script>
</body>
</html>
